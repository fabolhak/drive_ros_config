sudo: required

language: cpp

services:
  - docker

env:
  global:
    - toolset_branch: master
    - ros_release: kinetic
    - ubuntu_version: xenial
    - docker_image: "shadowrobot/build-tools:$ubuntu_version-$ros_release"
    - used_modules: check_build,software_tests,codecov_tool #check_cache,code_style_check,check_deb_make,codecov_tool
    # available modules: https://github.com/shadow-robot/sr-build-tools/blob/master/ansible/roles/ci/doc/modules.md

before_install:
  # pull docker image from shadowrobot
  - docker pull $docker_image
  
script:
# get CI-environment for codecov
# run docker image from shadowrobot in ansible working directory and and with travis build dir as mounted volume
# bash command to run in docker container consists of
#   - download ximea drivers  
#   - extract ximea drivers
#   - remove udevadm command in ximea install script (because it does not work in the docker container)
#   - auto approval of firewire camera warning in ximea install script
#   - install ximea drivers
#   - pull latest ansible playbook files from sr robotics
#   - checkout correct branch
#   - run ansible playbook with provided parameters
  - >
      ci_env=`bash <(curl -s https://codecov.io/env)` &&
      docker run $ci_env -w "/home/user/sr-build-tools/ansible" -v $TRAVIS_BUILD_DIR:/host$TRAVIS_BUILD_DIR
      $docker_image 
      bash -c "
               wget -q http://www.ximea.com/downloads/recent/XIMEA_Linux_SP.tgz &&
               tar xzf XIMEA_Linux_SP.tgz &&
               cd package &&
               sed -i -e 's/udevadm control --reload/echo removed command/g' scripts/install_steps &&
               sed -i -e 's/read choice/echo automatic approval/g' scripts/install_steps &&
               ./install &&
               cd .. &&
               git pull && 
               git checkout $toolset_branch &&
               sudo PYTHONUNBUFFERED=1 ansible-playbook -v -i \"localhost,\" -c local docker_site.yml --tags \"travis,$used_modules\" -e \"CODECOV_ENV=$CODECOV_ENV CODECOV_TOKEN=$CODECOV_TOKEN CODECOV_URL=$CODECOV_URL CODECOV_SLUG=$CODECOV_SLUG VCS_COMMIT_ID=$VCS_COMMIT_ID VCS_BRANCH_NAME=$VCS_BRANCH_NAME VCS_PULL_REQUEST=$VCS_PULL_REQUEST VCS_SLUG=$VCS_SLUG VCS_TAG=$VCS_TAG CI_BUILD_URL=$CI_BUILD_URL CI_BUILD_ID=$CI_BUILD_ID CI_JOB_ID=$CI_JOB_ID CI=$CI TRAVIS=$TRAVIS SHIPPABLE=$SHIPPABLE TRAVIS_BRANCH=$TRAVIS_BRANCH TRAVIS_COMMIT=$TRAVIS_COMMIT TRAVIS_JOB_NUMBER=$TRAVIS_JOB_NUMBER TRAVIS_PULL_REQUEST=$TRAVIS_PULL_REQUEST TRAVIS_JOB_ID=$TRAVIS_JOB_ID TRAVIS_REPO_SLUG=$TRAVIS_REPO_SLUG TRAVIS_TAG=$TRAVIS_TAG TRAVIS_OS_NAME=$TRAVIS_OS_NAME codecov_secure=$CODECOV_TOKEN travis_repo_dir=/host$TRAVIS_BUILD_DIR  travis_is_pull_request=$TRAVIS_PULL_REQUEST ros_release=$ros_release ubuntu_version=$ubuntu_version\" &&
               cat /home/user/workspace/codecoverage/coverage.cpp.xml
              "
